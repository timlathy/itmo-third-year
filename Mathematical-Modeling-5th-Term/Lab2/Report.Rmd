---
title: "Результаты моделирования"
output: word_document
---

```{r setup, include = FALSE}
library(jsonlite)
library(dplyr)
library(flextable)
library(ggplot2)
library(tidyr)

models <- jsonlite::fromJSON("models.json", flatten = TRUE)

load_results <- . %>%
  lapply(function(n) n - 1) %>%
  paste0("model", ., ".json") %>%
  lapply(jsonlite::fromJSON) %>%
  bind_rows(.id = "model")
```

```{r, echo = FALSE}
# https://stackoverflow.com/a/57193998
fit_flextable <- function(table, pgwidth = 8){
  table_af <- autofit(table)
  width(table_af, width = dim(table_af)$widths * pgwidth / flextable_dim(table_af)$widths)
}

models_table <- function(selector)
  models[selector,] %>%
    mutate(id = row_number()) %>%
    select(
      id, num_servers, queue_capacity,
      arrival_dist.kind, arrival_dist.mean, service_dist.kind, service_dist.mean) %>%
    flextable() %>%
    set_header_labels(
      id = "№",
      num_servers = "Приборы",
      queue_capacity = "Накопитель",
      arrival_dist.kind = "Р-е инт. поступления",
      arrival_dist.mean = "М.О. пост.",
      service_dist.kind = "Р-е инт. обслуживания",
      service_dist.mean = "М.О. обсл.") %>%
    theme_box() %>%
    fit_flextable()
```

## 1. Исследование влияния загрузки на длительность переходного режима

Таблица 1. Исследуемые варианты

```{r, echo = FALSE}
ms_transient <- load_results(1:3)
models_table(1:3)
```

```{r, echo = FALSE}
lagdiff <- . %>% { (. / lag(.) - 1) * 100 } %>% { ifelse(is.finite(.), round(., digits = 2), 0) }

transient_state_table <- function(data, model)
  data %>%
    filter(task_count %in% c(300, 1000, 10000, 50000, 80000, 100000, 200000, 400000, 600000, 800000, 1000000)) %>%
    mutate(
      mean_wait_time_diff = lagdiff(mean_wait_time),
      loss_probability_diff = lagdiff(loss_probability)) %>%
    select(
      task_count, utilization, loss_probability, loss_probability_diff,
      mean_wait_time, mean_wait_time_diff, mean_residence_time) %>%
    flextable() %>%
    set_header_labels(
      task_count = "Заявок",
      utilization = "Загрузка",
      loss_probability = "Вер. потери",
      loss_probability_diff = "Вер. П %",
      mean_wait_time = "Время ожидания",
      mean_wait_time_diff = "ВО %",
      mean_residence_time = "Время пребывания") %>%
    theme_box() %>%
    fit_flextable()
```

Таблица 2. Результаты моделирования варианта 1 ($\rho \approx 0.1$)

```{r, echo = FALSE}
transient_state_table(ms_transient[ms_transient$model == 1,])
```

Таблица 3. Результаты моделирования варианта 2 ($\rho \approx 0.5$)

```{r, echo = FALSE}
transient_state_table(ms_transient[ms_transient$model == 2,])
```

Таблица 4. Результаты моделирования варианта 3 ($\rho \approx 0.9$)

```{r, echo = FALSE}
transient_state_table(ms_transient[ms_transient$model == 3,])
```

### Графики зависимостей

```{r, echo = FALSE}
transient_state_plot <- function(data, y, ylabel) {
  ggplot(data, aes(x = task_count, group = factor(model))) +
    geom_line(aes(y = y, color = factor(model))) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 8), labels = function(x) format(x, scientific = FALSE)) +
    scale_color_discrete(labels = c("0.1", "0.5", "0.9")) +
    labs(x = "Число заявок", y = ylabel, color = "Загрузка")
}
```

```{r, echo = FALSE}
ms_transient_plt <- ms_transient[ms_transient$task_count <= 800000,]
transient_state_plot(ms_transient_plt, y = ms_transient_plt$mean_wait_time, ylabel = "Среднее время ожидания")
```

График 1. Зависимость среднего времени ожидания от числа заявок

```{r, echo = FALSE}
transient_state_plot(ms_transient_plt, y = ms_transient_plt$loss_probability, ylabel = "Вероятность потери")
```

График 2. Зависимость вероятности потери от числа заявок

## 2. Исследование влияния распределений потока заявок и времени обслуживания на среднее время ожидания и вероятность потери

Таблица 5. Исследуемые варианты

```{r, echo = FALSE}
models_table(4:8)
```

```{r, echo  = FALSE}
ms_exp_var <- load_results(4:8)

ms_exp_var_plt <- mutate(ms_exp_var[ms_exp_var$task_count == 1000000,], model=recode_factor(model,
    `1`="Увеличение l", `2`="Уменьшение l", `3`="", `4`="Увеличение mu", `5`="Уменьшение mu"))

ggplot(ms_exp_var_plt, aes(x = model, y = mean_wait_time)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "Экспоненциальное распределение", y = "Среднее время ожидания") +
  theme_minimal()
```

График 3. Зависимость среднего времени ожидания от параметров экспоненциального распределения интенсивности поступления и обслуживания

```{r, echo  = FALSE}
ggplot(ms_exp_var_plt, aes(x = model, y = loss_probability)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "Экспоненциальное распределение", y = "Среднее время ожидания") +
  theme_minimal()
```

График 4. Зависимость вероятности потери от параметров экспоненциального распределения интенсивности поступления и обслуживания


```{r, echo  = FALSE}
ms_exp_var <- load_results(12:15)

ms_exp_var_plt <- mutate(ms_exp_var[ms_exp_var$task_count == 1000000,], model=recode_factor(model,
    `1`="Экспоненциальное", `2`="Равномерное", `3`="Эрланга 2-го порядка", `4`="Гиперэкспоненциальное"))

ggplot(ms_exp_var_plt, aes(x = model, y = mean_wait_time)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "", y = "Среднее время ожидания") +
  theme_minimal()
```

График 5. Зависимость среднего времени ожидания от закона распределения интенсивности обработки заявок

```{r, echo  = FALSE}
ms_exp_var <- load_results(12:15)

ms_exp_var_plt <- mutate(ms_exp_var[ms_exp_var$task_count == 1000000,], model=recode_factor(model,
    `1`="Экспоненциальное", `2`="Равномерное", `3`="Эрланга 2-го порядка", `4`="Гиперэкспоненциальное"))

ggplot(ms_exp_var_plt, aes(x = model, y = loss_probability)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "", y = "Вероятность потери") +
  theme_minimal()
```

График 6. Зависимость вероятности потери от закона распределения интенсивности обработки заявок

```{r, echo  = FALSE}
ms_exp_var <- load_results(9:11)

ms_exp_var_plt <- mutate(ms_exp_var[ms_exp_var$task_count == 1000000,], model=recode_factor(model,
    `1`="Экспоненциальное", `2`="Трасса", `3`="Гипоэкспоненциальное"))

ggplot(ms_exp_var_plt, aes(x = model, y = mean_wait_time)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "", y = "Среднее время ожидания") +
  theme_minimal()
```

График 7. Зависимость времени ожидания от закона распределения интенсивности поступления заявок

```{r, echo  = FALSE}
ms_exp_var <- load_results(9:11)

ms_exp_var_plt <- mutate(ms_exp_var[ms_exp_var$task_count == 1000000,], model=recode_factor(model,
    `1`="Экспоненциальное", `2`="Трасса", `3`="Гипоэкспоненциальное"))

ggplot(ms_exp_var_plt, aes(x = model, y = loss_probability)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "", y = "Вероятность потери") +
  theme_minimal()
```

График 8. Зависимость вероятности потери от закона распределения интенсивности поступления заявок

```{r, echo = FALSE}
models_enum <- models[16:34,] %>% mutate(model = paste0(row_number()))
data <- load_results(16:34) %>% inner_join(models_enum, by = "model") %>% filter(task_count == 1000000)

data05 <- data %>%
  filter(utilization < 0.6) %>%
  mutate(mwt=mean_wait_time/max(mean_wait_time), lp=loss_probability/max(loss_probability)) %>%
  gather(prop, value, mwt, lp)

ggplot(data05, aes(x = queue_capacity, y = value, color = prop)) +
  geom_line() +
  scale_color_manual(labels=c("mwt"="Среднее время ожидания", "lp"="Вероятность потери"), values=c("mwt"="steelblue", "lp"="orange")) +
  labs(x = "Емкость накопителя", y = "", color = "")
```

График 9. Нормированный график зависимости среднего времени ожидания и вероятности потери от емкости накопителя при утилизации = 0.5

```{r, echo = FALSE}
data09 <- data %>%
  filter(utilization > 0.6) %>%
  mutate(mwt=mean_wait_time/max(mean_wait_time), lp=loss_probability/max(loss_probability)) %>%
  gather(prop, value, mwt, lp)

ggplot(data09, aes(x = queue_capacity, y = value, color = prop)) +
  geom_line() +
  scale_color_manual(labels=c("mwt"="Среднее время ожидания", "lp"="Вероятность потери"), values=c("mwt"="blue", "lp"="red")) +
  labs(x = "Емкость накопителя", y = "", color = "")
```

График 10. Нормированный график зависимости среднего времени ожидания и вероятности потери от емкости накопителя при утилизации = 0.9