---
title: "Результаты моделирования"
output: word_document
---

```{r setup, include = FALSE}
library(jsonlite)
library(dplyr)
library(flextable)
library(ggplot2)

load_models <- . %>% paste0("model", ., ".json") %>% lapply(jsonlite::fromJSON) %>% bind_rows(.id = "model")
```

## 1. Исследование влияния загрузки на длительность переходного режима

```{r, echo = FALSE}
ms_transient <- load_models(0:2)

transient_state_table <- function(data, model) {
  data %>%
    filter(task_count %in% c(300, 1000, 10000, 50000, 80000, 100000, 200000, 400000, 600000, 800000, 1000000)) %>%
    select(task_count, utilization, loss_probability, mean_wait_time, mean_residence_time) %>%
    flextable() %>%
    set_header_labels(
      task_count = "Заявок",
      utilization = "Загрузка",
      loss_probability = "Вер. потери",
      mean_wait_time = "Время ожидания",
      mean_residence_time = "Время пребывания") %>%
    theme_box() %>%
    autofit()
}
```

Таблица 1. Результаты моделирования варианта 1 ($\rho \approx 0.1$)

```{r, echo = FALSE}
transient_state_table(ms_transient[ms_transient$model == 1,])
```

Таблица 2. Результаты моделирования варианта 2 ($\rho \approx 0.5$)

```{r, echo = FALSE}
transient_state_table(ms_transient[ms_transient$model == 2,])
```

Таблица 3. Результаты моделирования варианта 3 ($\rho \approx 0.9$)

```{r, echo = FALSE}
transient_state_table(ms_transient[ms_transient$model == 3,])
```

### Графики зависимостей

```{r, echo = FALSE}
transient_state_plot <- function(data, y, ylabel) {
  ggplot(data, aes(x = task_count, group = factor(model))) +
    geom_line(aes(y = y, color = factor(model))) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 8), labels = function(x) format(x, scientific = FALSE)) +
    scale_color_discrete(labels = c("0.1", "0.5", "0.9")) +
    labs(x = "Число заявок", y = ylabel, color = "Загрузка")
}
```

```{r, echo = FALSE}
ms_transient_plt <- ms_transient[ms_transient$task_count <= 600000,]
transient_state_plot(ms_transient_plt, y = ms_transient_plt$mean_wait_time, ylabel = "Среднее время ожидания")
```

График 1. Зависимость среднего времени ожидания от числа заявок

```{r, echo = FALSE}
transient_state_plot(ms_transient_plt, y = ms_transient_plt$loss_probability, ylabel = "Вероятность потери")
```

График 2. Зависимость вероятности потери от числа заявок

## 2. Исследование влияния распределений потока заявок и времени обслуживания на среднее время ожидания

```{r, echo  = FALSE}
ms_exp_var <- load_models(3:7)

ms_exp_var_plt <- mutate(ms_exp_var[ms_exp_var$task_count == 1000000,], model=recode_factor(model,
    `1`="Увеличение l", `2`="Уменьшение l", `3`="", `4`="Увеличение mu", `5`="Уменьшение mu"))

ggplot(ms_exp_var_plt, aes(x = model, y = mean_wait_time)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "Экспоненциальное распределение", y = "Время ожидания") +
  theme_minimal()
```

График 3. Зависимость времени ожидания от параметров экспоненциального распределения интенсивности поступления и обслуживания
