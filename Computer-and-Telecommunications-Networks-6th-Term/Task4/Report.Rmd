---
title: "Основы администрирования маршрутизируемых компьютерных сетей"
output: html_document
---

## Цель

Изучение основных методов настройки маршрутизируемых компьютерных сетей на примере сети,
состоящей из компьютеров под управлением ОС Linux.

## Задание

В процессе выполнения работы изучается сетевой уровень модели OSI.
Производится базовая настройка связности в сети, управление таблицами маршрутизации и
правилами трансляции сетевых адресов. При помощи утилиты tcpdump выполняются наблюдения
за передачей трафика по каналам связи в маршрутизируемой компьютерной сети.
Применение утилиты tcpdump позволяет непосредственно в терминале (это основной метод
управления сетевым оборудованием) наблюдать проходящие через интерфейсы компьютера
пакеты и изучить их внутреннюю структуру.

## Исходные данные

Вариант выполнения работы V1 = 1 + (14 mod 5) = 5.

![Рис. 1. Топология сети и схема прохождения трафика для варианта 5](net-topology.png)

На рисунке 1 изображена топология сети и требуемый путь прохождения сетевых пакетов.

С компьютера 4 посылается `ICMP Echo Request` на адрес, который не существует в данной сети.
На компьютерах 1, 2 и 3 должны быть настроены таблицы маршрутизации и правила NAT
таким образом, чтобы пакет поочередно прошел через компьютеры 3, 2, 1
и, снова пройдя через компьютер 3, пришел на компьютер 4 (сплошные линии
на рисунке 1) с IP заголовком, в котором IP адрес источника и IP адрес
назначения будут поменяны местами.

Таким образом, компьютер 4 получит `ICMP Echo Request` на свой локальный адрес
и ответит на него. `ICMP Echo Reply` должен пройти обратный путь (4->3->1->2->3->4)
и прийти на компьютер 4 (штриховые линии на рисунке 1) с поменяными местами
адресами источника и назначения.

В результате выполнения команды `ping` должна быть выведена информация об
успешном выполнении. То есть компьютер 4 сам отвечает на собственные ICMP запросы,
однако пакет проходит через внешнюю сеть маршрутизаторов.

## Ход работы

### Настройка сети

Настроим IPv4 адреса компьютеров `A.B.X.Y/M` в топологии следующим образом:
* `A` равно количеству букв в имени студента (7)
* `B` равно количеству букв в фамилии студента (7)
* `X` и `Y` выбирается случайно
* `M` принимается равной 30, максимальному значению для обеспечения связи двух компьютеров
(два адреса из четырех возможных — минимальный и максимальный — зарезервированы)

Назначим следующие адреса подсетей:
* `7.7.12.0/30` для связи компьютеров 1 и 3 (сетевой адаптер `s1_s2` в VirtualBox)
* `7.7.13.0/30` для связи компьютеров 1 и 3 (сетевой адаптер `s1_s3` в VirtualBox)
* `7.7.23.0/30` для связи компьютеров 2 и 3 (сетевой адаптер `s2_s3` в VirtualBox)
* `7.7.34.0/30` для связи компьютеров 3 и 4 (сетевой адаптер `s3_s4` в VirtualBox)

Для IPv6 адресов назначим маску `/127` (2 адреса) и следующие адреса подсетей:
* `::ffff:7.7.12.0/127` (`0:0:0:0:0:ffff:707:c00/127`) для `s1_s2`
* `::ffff:7.7.13.0/127` для `s1_s3`
* `::ffff:7.7.23.0/127` для `s2_s3`
* `::ffff:7.7.34.0/127` для `s3_s4`

Настройка компьютера `s1`:
```
ip link set eth0 up
ip link set eth1 up

ip a add 7.7.12.1/30 dev eth0
ip a add 7.7.13.1/30 dev eth1
ip -6 a add ::ffff:7.7.12.0/127 dev eth0
ip -6 a add ::ffff:7.7.13.0/127 dev eth1

ip ro add 7.7.34.2 via 7.7.13.2
ip -6 ro add ::ffff:7.7.34.1 via ::ffff:7.7.13.1
```

Настройка компьютера `s2`:
```
ip link set eth0 up
ip link set eth1 up

ip a add 7.7.12.2/30 dev eth0
ip a add 7.7.23.1/30 dev eth1
ip -6 a add ::ffff:7.7.12.1/127 dev eth0
ip -6 a add ::ffff:7.7.23.0/127 dev eth1

ip ro add 7.7.34.2 via 7.7.23.2
```

Настройка компьютера `s3`:
```
ip link set eth0 up
ip link set eth1 up
ip link set eth2 up

ip a add 7.7.13.2/30 dev eth0
ip a add 7.7.23.2/30 dev eth1
ip a add 7.7.34.1/30 dev eth2
ip -6 a add ::ffff:7.7.13.1/127 dev eth0
ip -6 a add ::ffff:7.7.23.1/127 dev eth1
ip -6 a add ::ffff:7.7.34.0/127 dev eth2

sysctl -w net.ipv4.ip_forward=1
sysctl -w net.ipv4.conf.all.rp_filter=0
```

Настройка компьютера `s4`:
```
ip link set eth0 up

ip a add 7.7.34.2/30 dev eth0
ip -6 a add ::ffff:7.7.34.1/127 dev eth0

ip ro add 7.7.13.1 via 7.7.34.1
ip ro add 7.7.23.1 via 7.7.34.1
```

### Проверка работоспособности

Для проверки сети возьмем компьютеры #1 и #4, трафик между которыми проходит
через шлюз, которым выступает компьютер #3.

![Рис. 2. Вывод утилиты nc](part1-nc.png)
